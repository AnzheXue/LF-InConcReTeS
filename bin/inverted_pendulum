#!/bin/bash -l
# Launcher for federated inverted_pendulum.lf Lingua Franca program.
# Uncomment to specify to behave as close as possible to the POSIX standard.
# set -o posix

# Enable job control
set -m
shopt -s huponexit

# Set a trap to kill all background jobs on error or control-C
# Use two distinct traps so we can see which signal causes this.
cleanup() {
    if [ "$EXITED_SUCCESSFULLY" = true ] ; then
        exit 0
    else
        printf "Killing federate %s.\n" ${pids[*]}
        # The || true clause means this is not an error if kill fails.
        kill ${pids[@]} || true
        printf "#### Killing RTI %s.\n" ${RTI}
        kill ${RTI} || true
        exit 1
    fi
}

trap 'cleanup; exit' EXIT

# Create a random 48-byte text ID for this federation.
# The likelihood of two federations having the same ID is 1/16,777,216 (1/2^24).
FEDERATION_ID=`openssl rand -hex 24`
echo "Federate inverted_pendulum in Federation ID '$FEDERATION_ID'"
# Launch the federates:
#### Host is 10.34.167.169
echo "#### Launching the runtime infrastructure (RTI) on remote host 10.34.167.169."
# FIXME: Killing this ssh does not kill the remote process.
# A double -t -t option to ssh forces creation of a virtual terminal, which
# fixes the problem, but then the ssh command does not execute. The remote
# federate does not start!
ssh 10.34.167.169 'mkdir -p log; \
    echo "-------------- Federation ID: "'$FEDERATION_ID' >> log/inverted_pendulum_RTI.log; \
    date >> log/inverted_pendulum_RTI.log; \
    echo "Executing RTI: ~/LinguaFrancaRemote/inverted_pendulum/bin/RTI -i '${FEDERATION_ID}' \
                        -t \
                        -n 9 \
                        -c init \
exchanges-per-interval 10 \
" 2>&1 | tee -a log/inverted_pendulum_RTI.log; \
    # First, check if the RTI is on the PATH
    if ! command -v RTI &> /dev/null
    then
        echo "RTI could not be found."
        echo "The source code can be found in org.lflang/src/lib/core/federated/RTI"
        exit 1
    fi
    ~/LinguaFrancaRemote/inverted_pendulum/bin/RTI -i '${FEDERATION_ID}' \
                        -t \
                        -n 9 \
                        -c init \
exchanges-per-interval 10 \ 2>&1 | tee -a log/inverted_pendulum_RTI.log' &
# Store the PID of the channel to RTI
RTI=$!
# Wait for the RTI to boot up before
# starting federates (this could be done by waiting for a specific output
# from the RTI, but here we use sleep)
sleep 5
echo "#### Launching the federate federate__s1 on host 10.34.167.170"
# FIXME: Killing this ssh does not kill the remote process.
# A double -t -t option to ssh forces creation of a virtual terminal, which
# fixes the problem, but then the ssh command does not execute. The remote
# federate does not start!
ssh 10.34.167.170 '
    cd LinguaFrancaRemote; \
    echo "Executing: ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__s1 -i '$FEDERATION_ID'" 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__s1.log; 
    ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__s1 -i '$FEDERATION_ID' 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__s1.log' &
pids[0]=$!
echo "#### Launching the federate federate__s2 on host 10.34.167.171"
# FIXME: Killing this ssh does not kill the remote process.
# A double -t -t option to ssh forces creation of a virtual terminal, which
# fixes the problem, but then the ssh command does not execute. The remote
# federate does not start!
ssh 10.34.167.171 '
    cd LinguaFrancaRemote; \
    echo "Executing: ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__s2 -i '$FEDERATION_ID'" 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__s2.log; 
    ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__s2 -i '$FEDERATION_ID' 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__s2.log' &
pids[1]=$!
echo "#### Launching the federate federate__s3 on host 10.34.167.172"
# FIXME: Killing this ssh does not kill the remote process.
# A double -t -t option to ssh forces creation of a virtual terminal, which
# fixes the problem, but then the ssh command does not execute. The remote
# federate does not start!
ssh 10.34.167.172 '
    cd LinguaFrancaRemote; \
    echo "Executing: ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__s3 -i '$FEDERATION_ID'" 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__s3.log; 
    ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__s3 -i '$FEDERATION_ID' 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__s3.log' &
pids[2]=$!
echo "#### Launching the federate federate__s4 on host 10.34.167.173"
# FIXME: Killing this ssh does not kill the remote process.
# A double -t -t option to ssh forces creation of a virtual terminal, which
# fixes the problem, but then the ssh command does not execute. The remote
# federate does not start!
ssh 10.34.167.173 '
    cd LinguaFrancaRemote; \
    echo "Executing: ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__s4 -i '$FEDERATION_ID'" 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__s4.log; 
    ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__s4 -i '$FEDERATION_ID' 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__s4.log' &
pids[3]=$!
echo "#### Launching the federate federate__p1 on host 10.34.167.170"
# FIXME: Killing this ssh does not kill the remote process.
# A double -t -t option to ssh forces creation of a virtual terminal, which
# fixes the problem, but then the ssh command does not execute. The remote
# federate does not start!
ssh 10.34.167.170 '
    cd LinguaFrancaRemote; \
    echo "Executing: ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__p1 -i '$FEDERATION_ID'" 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__p1.log; 
    ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__p1 -i '$FEDERATION_ID' 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__p1.log' &
pids[4]=$!
echo "#### Launching the federate federate__p2 on host 10.34.167.171"
# FIXME: Killing this ssh does not kill the remote process.
# A double -t -t option to ssh forces creation of a virtual terminal, which
# fixes the problem, but then the ssh command does not execute. The remote
# federate does not start!
ssh 10.34.167.171 '
    cd LinguaFrancaRemote; \
    echo "Executing: ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__p2 -i '$FEDERATION_ID'" 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__p2.log; 
    ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__p2 -i '$FEDERATION_ID' 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__p2.log' &
pids[5]=$!
echo "#### Launching the federate federate__p3 on host 10.34.167.172"
# FIXME: Killing this ssh does not kill the remote process.
# A double -t -t option to ssh forces creation of a virtual terminal, which
# fixes the problem, but then the ssh command does not execute. The remote
# federate does not start!
ssh 10.34.167.172 '
    cd LinguaFrancaRemote; \
    echo "Executing: ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__p3 -i '$FEDERATION_ID'" 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__p3.log; 
    ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__p3 -i '$FEDERATION_ID' 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__p3.log' &
pids[6]=$!
echo "#### Launching the federate federate__p4 on host 10.34.167.173"
# FIXME: Killing this ssh does not kill the remote process.
# A double -t -t option to ssh forces creation of a virtual terminal, which
# fixes the problem, but then the ssh command does not execute. The remote
# federate does not start!
ssh 10.34.167.173 '
    cd LinguaFrancaRemote; \
    echo "Executing: ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__p4 -i '$FEDERATION_ID'" 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__p4.log; 
    ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__p4 -i '$FEDERATION_ID' 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__p4.log' &
pids[7]=$!
echo "#### Launching the federate federate__plant on host 10.34.167.169"
# FIXME: Killing this ssh does not kill the remote process.
# A double -t -t option to ssh forces creation of a virtual terminal, which
# fixes the problem, but then the ssh command does not execute. The remote
# federate does not start!
ssh 10.34.167.169 '
    cd LinguaFrancaRemote; \
    echo "Executing: ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__plant -i '$FEDERATION_ID'" 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__plant.log; 
    ~/LinguaFrancaRemote/inverted_pendulum/bin/federate__plant -i '$FEDERATION_ID' 2>&1 | tee -a ~/LinguaFrancaRemote/inverted_pendulum/log/federate__plant.log' &
pids[8]=$!
echo "RTI has exited. Wait for federates to exit."
# Wait for launched processes to finish.
# The errors are handled separately via trap.
for pid in "${pids[@]}"
do
    wait $pid || exit $?
done
echo "All done."
EXITED_SUCCESSFULLY=true
